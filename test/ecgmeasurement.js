var should = require('should');
var assert = require('assert');
var request = require('supertest');
var config = require('../config/settings');

var url = config.baseUrl;
var jwtToken = undefined;

describe('ECG measurement controller', function () {

    before(function (done) {
        var endpoint = 'user/login';

        var user = {
            email: 'johnbakker@gmail.com',
            password: 'test'
        };
        request(url)
            .post(endpoint)
            .send(user)
            // end handles the response
            .end(function (err, res) {
                if (err) {
                    throw err;
                }

                jwtToken = res.body.token;

                done();
            });
    });

    describe('GET /measurement/ecg:', function () {
        var endpoint = 'measurement/ecg';

        it('should return an array with one item', function (done) {
            request(url)
                .get(endpoint)
                .set('Authorization', 'Bearer ' + jwtToken)
                // end handles the response
                .end(function (err, res) {
                    if (err) {
                        throw err;
                    }
                    // Status code should match with 200 (Success)
                    res.status.should.equal(200);

                    // Result object should be present
                    should.exist(res.body.result);

                    // Check if the errors are empty
                    res.body.error.should.equal('');

                    // Result object should not be empty
                    res.body.result.should.not.equal('');

                    // Check if it has one result
                    res.body.result.should.have.lengthOf(1);

                    // Results should be from the current userId
                    res.body.result[0].userId.should.equal(1);

                    done();
                });
        });

    });

    describe('POST /measurement/ecg:', function () {
        var endpoint = 'measurement/ecg';

        before(function (done2) {
            var measurement = {
                measurementValue: "[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-0.08162994369513754,-2.507091295957661,5.64701402161289,16.88383918462547,20.87229895948058,13.945421822901078,2.4717466693275627,-4.799882478608441,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4.699961457764901,5.843085785269171,2.564279281402981,0.0,0.0,0.479425538604203,0.8414709848078965,0.9974949866040544,0.9092974268256817,0.5984721441039564,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1.6014558686418372,11.581439857053786,20.98252014449526,12.829180348192224,-2.733917629027844,-1.943803007028385,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.387854840370213,5.592234515803359,5.843085785269172,4.052779083306904,0.8467200483592032,0.0,0.0,0.7833269096274834,0.9738476308781951,0.42737988023383017,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.365883939231586,3.637189707302727,0.5644800322394689,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-2.4192248866741934,0.5335160931552974,12.738496362160534,20.858018806524,16.01900631470114,3.509569274696143,-4.799882478608441,0.0,0.0,0.0,0.0,0.0,3.865306123426147,5.912698379930761,5.179256199893242,2.009928900935428,0.0,0.0,0.6442176872376911,0.9854497299884603,0.8632093666488737,0.33498815015590466,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.365883939231586,3.637189707302727,0.5644800322394689,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1.4589092689630583,1.4248003455321498,16.88383918462547,19.255186897059367,4.6022504489768785,-4.550132749815803,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.865306123426147,5.912698379930761,5.179256199893242,2.009928900935428,0.0,0.0,0.8414709848078965,0.9092974268256817,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,-2.730361411981164,-0.27317385067185285,9.201766805812197,18.52401436618984,20.638677730141033,13.945421822901078,3.509569274696143,-4.571234760797895,-1.943803007028385,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.387854840370213,5.592234515803359,5.843085785269172,4.052779083306904,0.8467200483592032,0.0,0.0,0.479425538604203,0.8414709848078965,0.9974949866040544,0.9092974268256817,0.5984721441039564,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]",
                measurementDate: '2015-09-27T11:52:16.000Z'
            };

            request(url)
                .post(endpoint)
                .send(measurement)
                .set('Authorization', 'Bearer ' + jwtToken)
                .end(function (err, res) {
                    if (err) {
                        throw err;
                    }

                    done2();
                })
        });

        it('should return an array with two item when one is added', function (done) {

            request(url)
                .get(endpoint)
                .set('Authorization', 'Bearer ' + jwtToken)
                // end handles the response
                .end(function (err, res) {
                    if (err) {
                        throw err;
                    }
                    // Status code should match with 200 (Success)
                    res.status.should.equal(200);

                    // Result object should be present
                    should.exist(res.body.result);

                    // Check if the errors are empty
                    res.body.error.should.equal('');

                    // Result object should not be empty
                    res.body.result.should.not.equal('');

                    // Check if it has one result
                    res.body.result.should.have.lengthOf(2);

                    // Results should be from the current userId
                    res.body.result[1].userId.should.equal(1);

                    done();
                });
        });
    })

    describe('DELETE /measurement/ecg:', function () {
        var endpoint = 'measurement/ecg';

        before(function (done2) {
            var measurement = {
                measurementValue: "[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-0.08162994369513754,-2.507091295957661,5.64701402161289,16.88383918462547,20.87229895948058,13.945421822901078,2.4717466693275627,-4.799882478608441,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4.699961457764901,5.843085785269171,2.564279281402981,0.0,0.0,0.479425538604203,0.8414709848078965,0.9974949866040544,0.9092974268256817,0.5984721441039564,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1.6014558686418372,11.581439857053786,20.98252014449526,12.829180348192224,-2.733917629027844,-1.943803007028385,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.387854840370213,5.592234515803359,5.843085785269172,4.052779083306904,0.8467200483592032,0.0,0.0,0.7833269096274834,0.9738476308781951,0.42737988023383017,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.365883939231586,3.637189707302727,0.5644800322394689,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-2.4192248866741934,0.5335160931552974,12.738496362160534,20.858018806524,16.01900631470114,3.509569274696143,-4.799882478608441,0.0,0.0,0.0,0.0,0.0,3.865306123426147,5.912698379930761,5.179256199893242,2.009928900935428,0.0,0.0,0.6442176872376911,0.9854497299884603,0.8632093666488737,0.33498815015590466,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.365883939231586,3.637189707302727,0.5644800322394689,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1.4589092689630583,1.4248003455321498,16.88383918462547,19.255186897059367,4.6022504489768785,-4.550132749815803,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.865306123426147,5.912698379930761,5.179256199893242,2.009928900935428,0.0,0.0,0.8414709848078965,0.9092974268256817,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.869424363598091,3.9982944121660204,2.701852722204604,0.0,0.0,0.0,0.0,0.0,-2.730361411981164,-0.27317385067185285,9.201766805812197,18.52401436618984,20.638677730141033,13.945421822901078,3.509569274696143,-4.571234760797895,-1.943803007028385,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.387854840370213,5.592234515803359,5.843085785269172,4.052779083306904,0.8467200483592032,0.0,0.0,0.479425538604203,0.8414709848078965,0.9974949866040544,0.9092974268256817,0.5984721441039564,0.1411200080598672,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]",
                measurementDate: '2015-09-27T11:52:16.000Z'
            };

            request(url)
                .post(endpoint)
                .send(measurement)
                .set('Authorization', 'Bearer ' + jwtToken)
                .end(function (err, res) {
                    if (err) {
                        throw err;
                    }

                    // Check if the inserted id equals 4
                    (res.body.result.online_id).should.equal(4);

                    done2();
                })
        });

        it('should delete a measurement when correct id is given', function (done) {

            request(url)
                .delete(endpoint)
                .send({
                    id: 4
                })
                .set('Authorization', 'Bearer ' + jwtToken)
                // end handles the response
                .end(function (err, res) {
                    if (err) {
                        throw err;
                    }
                    // Status code should match with 200 (Success)
                    res.status.should.equal(200);

                    // Result object should be present
                    should.exist(res.body.result);

                    // Check if the errors are empty
                    res.body.error.should.equal('');

                    // Result object should not be empty
                    res.body.result.should.not.equal('');

                    request(url)
                        .get(endpoint)
                        .set('Authorization', 'Bearer ' + jwtToken)
                        // end handles the response
                        .end(function (err, res) {
                            if (err) {
                                throw err;
                            }
                            // Status code should match with 200 (Success)
                            res.status.should.equal(200);

                            // Result object should be present
                            should.exist(res.body.result);

                            // Check if the errors are empty
                            res.body.error.should.equal('');

                            // Result object should not be empty
                            res.body.result.should.not.equal('');

                            // Check if it has one result
                            res.body.result.should.have.lengthOf(2);

                            // Results should be from the current userId
                            res.body.result[1].userId.should.equal(1);

                            done();
                        });
                });
        });
    })

});